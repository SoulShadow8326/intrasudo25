<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0D0E11">
    <meta name="description" content="Admin Dashboard for Intra Sudo 2025">
    <title>Admin Dashboard - Intra Sudo 2025</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
</head>
<body>
    <nav class="navbar">
        <div class="nav-left">
            <a href="index.html" class="logo-link">
                <img class="logo-img" src="assets/logo-blue.png" alt="Sudocrypt" />
                <span class="nav-brand">Intra Sudo vX.X</span>
            </a>
        </div>
        <div class="nav-center">
            <a href="index.html" class="nav-link">Home</a>
            <a href="leaderboard.html" class="nav-link">Leaderboard</a>
            <a href="hints.html" class="nav-link">Hints</a>
        </div>
        <div class="nav-right">
            <a href="admin.html" class="nav-link active">Admin</a>
            <a href="#" class="nav-link" onclick="handleLogout()">Log Out</a>
        </div>
    </nav>

    <div class="page-container">
        <div class="main-content-pages">
            <div class="admin-container">
                <header class="admin-header">
                    <h1 class="admin-title">Admin Dashboard</h1>
                    <p class="admin-subtitle">Manage levels, monitor users, and control system settings</p>
                </header>

                <div class="admin-dashboard">

                    <section class="admin-section">
                        <div class="section-header">
                            <h2 class="section-title">System Overview</h2>
                        </div>
                        <div class="stats-grid" id="statsGrid">
                            <div class="stat-card">
                                <div class="stat-value" id="totalUsers">-</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="totalLevels">-</div>
                                <div class="stat-label">Total Levels</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="activeUsers">-</div>
                                <div class="stat-label">Active Users</div>
                            </div>
                        </div>
                    </section>


                    <section class="admin-section">
                        <div class="section-header">
                            <h2 class="section-title">Level Management</h2>
                            <button class="btn-primary" onclick="toggleAddLevelForm()">
                                Add New Level
                            </button>
                        </div>


                        <div class="add-level-form" id="addLevelForm">
                            <div class="form-group">
                                <label class="form-label" for="levelNumber">Level Number:</label>
                                <input type="number" id="levelNumber" class="form-input" placeholder="Enter level number" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="levelTitle">Level Title:</label>
                                <input type="text" id="levelTitle" class="form-input" placeholder="Enter level title">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="levelQuestion">Level Question:</label>
                                <textarea id="levelQuestion" class="form-input form-textarea" placeholder="Enter the level question or description"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="levelAnswer">Correct Answer:</label>
                                <input type="text" id="levelAnswer" class="form-input" placeholder="Enter the correct answer">
                            </div>
                            <div class="form-actions">
                                <button class="btn-secondary" onclick="cancelAddLevel()">Cancel</button>
                                <button class="btn-primary" onclick="createLevel()">Create Level</button>
                            </div>
                        </div>


                        <div id="levelsContainer">
                            <div class="loading-state" id="levelsLoading">Loading levels...</div>
                            <div class="level-list" id="levelsList" style="display: none;"></div>
                            <div class="empty-state" id="levelsEmpty" style="display: none;">
                                <div class="empty-state-icon">?</div>
                                <p>No levels found. Create your first level to get started!</p>
                            </div>
                        </div>
                    </section>


                    <section class="admin-section" id="questionStateSection" style="display: none;">
                        <div class="section-header">
                            <h2 class="section-title">Question State Management</h2>
                            <div class="section-actions">
                                <button class="btn-primary" onclick="toggleAllQuestions(true)">
                                    Enable All
                                </button>
                                <button class="btn-danger" onclick="toggleAllQuestions(false)">
                                    Disable All
                                </button>
                            </div>
                        </div>
                        <div id="questionStateContainer">
                            <div class="question-state-list" id="questionStateList"></div>
                        </div>
                    </section>


                    <section class="admin-section">
                        <div class="section-header">
                            <h2 class="section-title">User Management</h2>
                            <button class="btn-primary" onclick="refreshUsers()">
                                Refresh
                            </button>
                        </div>
                        <div id="usersContainer">
                            <div class="loading-state">Loading users...</div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <script>
        let levels = [];
        let users = [];
        let stats = {};

        // Initialize admin dashboard
        async function initializeAdmin() {
            try {
                await Promise.all([
                    loadStats(),
                    loadLevels(),
                    loadUsers()
                ]);
            } catch (error) {
                console.error('Failed to initialize admin dashboard:', error);
            }
        }

        // Load system statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats');
                stats = await response.json();
                updateStatsDisplay();
            } catch (error) {
                console.error('Failed to load stats:', error);
                // Initialize empty stats
                stats = {
                    totalUsers: 0,
                    totalLevels: 0,
                    activeUsers: 0
                };
                updateStatsDisplay();
            }
        }

        function updateStatsDisplay() {
            document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
            document.getElementById('totalLevels').textContent = stats.totalLevels || 0;
            document.getElementById('activeUsers').textContent = stats.activeUsers || 0;
        }

        // Level Management Functions
        async function loadLevels() {
            const container = document.getElementById('levelsContainer');
            const loading = document.getElementById('levelsLoading');
            const list = document.getElementById('levelsList');
            const empty = document.getElementById('levelsEmpty');

            try {
                loading.style.display = 'block';
                list.style.display = 'none';
                empty.style.display = 'none';

                const response = await fetch('/api/admin/levels');
                levels = await response.json();
                
                if (levels.length === 0) {
                    loading.style.display = 'none';
                    empty.style.display = 'block';
                    hideQuestionStateSection();
                } else {
                    renderLevels();
                    loading.style.display = 'none';
                    list.style.display = 'block';
                    // Hide question state section since backend doesn't support it
                    hideQuestionStateSection();
                }
            } catch (error) {
                console.error('Failed to load levels:', error);
                // Initialize empty levels array
                levels = [];
                loading.style.display = 'none';
                empty.style.display = 'block';
                hideQuestionStateSection();
            }
        }

        function renderLevels() {
            const list = document.getElementById('levelsList');
            list.innerHTML = levels.map(level => `
                <div class="level-item">
                    <div class="level-info">
                        <div class="level-number">${level.number}</div>
                        <div class="level-details">
                            <h4 class="level-title">${level.title}</h4>
                            <p class="level-description">${level.question.substring(0, 50)}${level.question.length > 50 ? '...' : ''}</p>
                            <div class="level-meta">
                                <span class="status-badge ${level.active ? 'status-active' : 'status-inactive'}">
                                    ${level.active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="level-actions">
                        <button class="btn-danger" onclick="deleteLevel(${level.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function toggleAddLevelForm() {
            const form = document.getElementById('addLevelForm');
            const isVisible = form.classList.contains('show');
            
            if (isVisible) {
                form.classList.remove('show');
            } else {
                form.classList.add('show');
                document.getElementById('levelNumber').focus();
            }
        }

        function cancelAddLevel() {
            const form = document.getElementById('addLevelForm');
            form.classList.remove('show');
            clearAddLevelForm();
        }

        function clearAddLevelForm() {
            document.getElementById('levelNumber').value = '';
            document.getElementById('levelTitle').value = '';
            document.getElementById('levelQuestion').value = '';
            document.getElementById('levelAnswer').value = '';
        }

        async function createLevel() {
            const levelNumber = document.getElementById('levelNumber').value;
            const levelTitle = document.getElementById('levelTitle').value.trim();
            const levelQuestion = document.getElementById('levelQuestion').value.trim();
            const levelAnswer = document.getElementById('levelAnswer').value.trim();

            // Validation
            if (!levelNumber || !levelTitle || !levelQuestion || !levelAnswer) {
                showNotification('Please fill in all required fields.', 'error');
                return;
            }

            // Create form data to match backend expectations
            const formData = new FormData();
            formData.append('level_number', levelNumber);
            formData.append('markdown', levelQuestion); // Backend expects markdown field
            formData.append('source_hint', levelQuestion); // Question IS the hint
            formData.append('console_hint', levelQuestion); // Question IS the hint
            formData.append('answer', levelAnswer);
            formData.append('active', 'true');

            try {
                const response = await fetch('/api/admin/levels', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    showNotification('Level created successfully!', 'success');
                    cancelAddLevel();
                    loadLevels();
                    loadStats();
                } else {
                    throw new Error('Failed to create level');
                }
            } catch (error) {
                console.error('Error creating level:', error);
                showNotification('Failed to create level. Please try again.', 'error');
            }
        }

        async function deleteLevel(levelId) {
            if (!confirm('Are you sure you want to delete this level? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/levels/${levelId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('Level deleted successfully!', 'success');
                    loadLevels();
                    loadStats();
                } else {
                    throw new Error('Failed to delete level');
                }
            } catch (error) {
                console.error('Error deleting level:', error);
                showNotification('Failed to delete level. Please try again.', 'error');
            }
        }

        // Question State Management
        function showQuestionStateSection() {
            document.getElementById('questionStateSection').style.display = 'block';
        }

        function hideQuestionStateSection() {
            document.getElementById('questionStateSection').style.display = 'none';
        }

        function renderQuestionStates() {
            const list = document.getElementById('questionStateList');
            list.innerHTML = levels.map(level => `
                <div class="question-state-item">
                    <div class="question-info">
                        <div class="question-number">Level ${level.number}</div>
                        <div class="question-title">${level.title}</div>
                    </div>
                    <div class="question-state-toggle">
                        <label class="toggle-switch">
                            <input type="checkbox" ${level.enabled !== false ? 'checked' : ''} onchange="toggleQuestionState(${level.id}, this.checked)">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">${level.enabled !== false ? 'Enabled' : 'Disabled'}</span>
                    </div>
                </div>
            `).join('');
        }

        async function toggleQuestionState(levelId, enabled) {
            try {
                const response = await fetch(`/api/admin/levels/${levelId}/state`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });

                if (response.ok) {
                    // Update local state
                    const level = levels.find(l => l.id === levelId);
                    if (level) {
                        level.enabled = enabled;
                    }
                    showNotification(`Question ${enabled ? 'enabled' : 'disabled'} successfully!`, 'success');
                    renderQuestionStates();
                } else {
                    throw new Error('Failed to update question state');
                }
            } catch (error) {
                console.error('Error updating question state:', error);
                showNotification('Failed to update question state. Please try again.', 'error');
                // Revert the toggle
                renderQuestionStates();
            }
        }

        async function toggleAllQuestions(enabled) {
            const confirmMessage = enabled ? 
                'Are you sure you want to enable all questions?' : 
                'Are you sure you want to disable all questions?';
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const response = await fetch('/api/admin/levels/bulk-state', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });

                if (response.ok) {
                    // Update local state
                    levels.forEach(level => level.enabled = enabled);
                    showNotification(`All questions ${enabled ? 'enabled' : 'disabled'} successfully!`, 'success');
                    renderQuestionStates();
                } else {
                    throw new Error('Failed to update question states');
                }
            } catch (error) {
                console.error('Error updating question states:', error);
                showNotification('Failed to update question states. Please try again.', 'error');
            }
        }

        // User Management
        async function loadUsers() {
            const container = document.getElementById('usersContainer');
            
            try {
                container.innerHTML = '<div class="loading-state">Loading users...</div>';
                
                const response = await fetch('/api/admin/users');
                if (response.ok) {
                    users = await response.json();
                    renderUsers();
                } else {
                    throw new Error('Failed to load users');
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                container.innerHTML = '<div class="error-state">Failed to load users</div>';
            }
        }

        function renderUsers() {
            const container = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">Users</div>
                        <p>No users found.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="user-list">
                    ${users.map(user => `
                        <div class="user-item">
                            <div class="user-info">
                                <div class="user-details">
                                    <h4 class="user-name">${user.Gmail}</h4>
                                    <p class="user-email">${user.Gmail}</p>
                                    <p class="user-level">Current Level: ${user.On}</p>
                                    <p class="user-status ${user.Verified ? 'verified' : 'unverified'}">
                                        ${user.Verified ? 'Verified' : 'Unverified'}
                                    </p>
                                    ${isAdminEmail(user.Gmail) ? '<p class="user-admin">Admin</p>' : ''}
                                </div>
                            </div>
                            <div class="user-actions">
                                ${!isAdminEmail(user.Gmail) ? `<button class="btn-danger" onclick="deleteUser('${user.Gmail}')">Delete</button>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function isAdminEmail(email) {
            const adminEmails = ['admin@intrasudo.com', 'lead@intrasudo.com', 'organizer@intrasudo.com'];
            return adminEmails.includes(email.toLowerCase());
        }

        async function deleteUser(email) {
            if (!confirm(`Are you sure you want to delete user ${email}? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${encodeURIComponent(email)}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showNotification('User deleted successfully!', 'success');
                    loadUsers();
                    loadStats();
                } else {
                    throw new Error('Failed to delete user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showNotification('Failed to delete user. Please try again.', 'error');
            }
        }

        async function refreshUsers() {
            await loadUsers();
            showNotification('Users refreshed!', 'success');
        }

        // Utility Functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Enhanced styling to match dark theme
            const bgColor = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#2977f5';
            const borderColor = type === 'success' ? 'rgba(34, 197, 94, 0.3)' : type === 'error' ? 'rgba(239, 68, 68, 0.3)' : 'rgba(41, 119, 245, 0.3)';
            
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 0.75rem;
                color: white;
                z-index: 1001;
                background: ${bgColor};
                border: 1px solid ${borderColor};
                box-shadow: 0 8px 25px rgba(0,0,0,0.4);
                animation: slideInRight 0.3s ease-out;
                font-weight: 500;
                font-size: 0.9rem;
                min-width: 200px;
                max-width: 300px;
                backdrop-filter: blur(10px);
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        async function handleLogout() {
            try {
                await fetch('/enter/logout', { method: 'POST' });
                window.location.href = 'auth.html';
            } catch (error) {
                console.error('Logout failed:', error);
                window.location.href = 'auth.html';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeAdmin);
    </script>

    <style>
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* Admin Dashboard Styles */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .admin-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .admin-title {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .admin-subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        .admin-section {
            background: rgba(13, 14, 17, 0.8) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            margin: 0;
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            color: white;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .add-level-form {
            display: none;
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border: 2px dashed #ddd;
        }

        .add-level-form.show {
            display: block;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn-primary, .btn-secondary, .btn-danger {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .level-list, .user-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .level-item, .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .level-info, .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .level-number {
            background: #007bff;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 50%;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }

        .level-title, .user-name {
            margin: 0 0 0.5rem 0;
            color: #333;
        }

        .level-description {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .level-meta {
            margin-top: 0.5rem;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .level-actions, .user-actions {
            display: flex;
            gap: 0.5rem;
        }

        .loading-state, .empty-state, .error-state {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .user-details p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }

        .user-status.verified {
            color: #28a745;
        }

        .user-status.unverified {
            color: #dc3545;
        }

        .user-admin {
            color: #ffc107;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .level-item, .user-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .level-actions, .user-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</body>
</html>
